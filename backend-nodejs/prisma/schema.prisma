generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Book {
  id            Int            @id @default(autoincrement())
  title         String
  pdfPath       String
  pages         Int
  chunks        Chunk[]
  // Opposite relation for StoryVersion.book
  storyVersions StoryVersion[]
  createdAt     DateTime       @default(now())
}

model Chunk {
  id         Int      @id @default(autoincrement())
  bookId     Int
  book       Book     @relation(fields: [bookId], references: [id])
  pageNumber Int
  text       String   @db.Text
  createdAt  DateTime @default(now())
}

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  name          String?
  role          String?
  // Opposite relation for StoryVersion.author
  storyVersions StoryVersion[]
  createdAt     DateTime       @default(now())
}

model StoryVersion {
  id              Int            @id @default(autoincrement())
  title           String?
  bookId          Int
  // relation to Book (Book.storyVersions is the opposite field)
  book            Book           @relation(fields: [bookId], references: [id])
  content         String         @db.Text
  authorId        Int?
  // relation to User (User.storyVersions is the opposite field)
  author          User?          @relation(fields: [authorId], references: [id])
  // self-relation for parent/children versioning
  parentVersionId Int?
  parentVersion   StoryVersion?  @relation("VersionHierarchy", fields: [parentVersionId], references: [id])
  childVersions   StoryVersion[] @relation("VersionHierarchy")
  createdAt       DateTime       @default(now())
  meta            StoryMeta[]
}

model StoryMeta {
  id             Int          @id @default(autoincrement())
  storyVersion   StoryVersion @relation(fields: [storyVersionId], references: [id])
  storyVersionId Int
  key            String
  value          String?
}
